<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>WiFi контроллер</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6ec6ff">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: Arial, sans-serif;
  min-height: 100svh;
  background: linear-gradient(180deg, #6ec6ff, #b3e5fc);
  overflow-x: hidden;
}

.wrapper {
  min-height: 100svh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding-top: 60px;
  padding-bottom: env(safe-area-inset-bottom);
}

.wave {
  position: fixed;
  width: 200%;
  height: 200px;
  left: 0;
  background: rgba(255,255,255,0.15);
  border-radius: 100%;
  animation: wave 12s infinite linear;
  z-index: 0;
}

.wave1 { top: 60%; }
.wave2 { top: 70%; opacity: 0.1; animation-duration: 20s; }

@keyframes wave {
  from { transform: translateX(0); }
  to { transform: translateX(-50%); }
}

.card {
  position: relative;
  z-index: 10;
  width: calc(100% - 32px);
  max-width: 360px;
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  text-align: center;
}

h2 {
  margin-top: 0;
}

.password-input {
  width: 100%;
  height: 56px;
  font-size: 18px;
  margin-bottom: 12px;
  padding: 0 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
}

.input-wrap {
  position: relative;
  margin-bottom: 16px;
}

.input-wrap input {
  width: 100%;
  height: 52px;
  padding: 0 52px 0 12px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

.save-btn {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: #f44336;
  color: white;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.3s;
}

.save-btn.ok {
  background: #4caf50;
}

button.main {
  width: 100%;
  height: 56px;
  font-size: 18px;
  margin-top: 10px;
  border: none;
  border-radius: 12px;
  background: #2196f3;
  color: white;
  cursor: pointer;
}
</style>
</head>

<body>

<div class="wave wave1"></div>
<div class="wave wave2"></div>

<div class="wrapper">

  <!-- LOGIN -->
  <div class="card" id="login" style="display:none;">
    <h2>Вход</h2>
    <input
      id="password"
      class="password-input"
      type="password"
      placeholder="Пароль"
      autocomplete="current-password"
      onkeydown="if(event.key==='Enter') loginAction()"
    >
    <button class="main" onclick="loginAction()">Войти</button>
  </div>

  <!-- MAIN -->
  <div class="card" id="main" style="display:none;">
    <h2>Управление</h2>

    <div class="input-wrap">
      <input
        id="host"
        placeholder="IP или IP:PORT"
        onkeydown="if(event.key==='Enter') saveIP()"
      >
      <button class="save-btn" id="ipBtn" onclick="saveIP()">✔</button>
    </div>

    <button class="main" onclick="sendCmd('/r1')">Ворота</button>
    <button class="main" onclick="sendCmd('/r2')">Калитка</button>
    <button class="main" onclick="sendCmd('/r3')">Гараж</button>
  </div>

</div>

<script>
const PASSWORD_HASH =
  "c2f02d39d5fe8bfa306c3b1beb9cf6fbc142f011af7b24641db9ae31fb5b9d50";

const loginEl = document.getElementById("login");
const mainEl = document.getElementById("main");
const passwordEl = document.getElementById("password");
const hostEl = document.getElementById("host");
const ipBtn = document.getElementById("ipBtn");

async function sha256(text) {
  const buf = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest("SHA-256", buf);
  return [...new Uint8Array(hash)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

function setCookie(name, value, days) {
  const d = new Date(Date.now() + days * 86400000).toUTCString();
  document.cookie = `${name}=${value}; expires=${d}; path=/; SameSite=Strict`;
}

function getCookie(name) {
  return document.cookie
    .split("; ")
    .find(c => c.startsWith(name + "="))
    ?.split("=")[1] || null;
}

function showLogin() {
  loginEl.style.display = "block";
  mainEl.style.display = "none";
}

function showMain() {
  loginEl.style.display = "none";
  mainEl.style.display = "block";
  hostEl.value = localStorage.getItem("host") || "";
  if (hostEl.value) ipBtn.classList.add("ok");
  passwordEl.value = "";
}

async function loginAction() {
  const hash = await sha256(passwordEl.value);
  if (hash === PASSWORD_HASH) {
    setCookie("session_id", PASSWORD_HASH, 365);
    showMain();
  } else {
    alert("Неверный пароль");
  }
}

(function init() {
  getCookie("session_id") === PASSWORD_HASH
    ? showMain()
    : showLogin();
})();

async function saveIP() {
  const h = hostEl.value.trim();
  if (!h) return alert("Введите IP");

  ipBtn.classList.remove("ok");

  try {
    await fetch(`//${h}`, {
      method: "GET",
      mode: "no-cors",
      cache: "no-store"
    });
    localStorage.setItem("host", h);
    ipBtn.classList.add("ok");
  } catch {
    alert("Устройство не отвечает");
  }
}

function sendCmd(cmd) {
  const h = hostEl.value.trim();
  if (!h) return alert("Введите IP");

  fetch(`//${h}${cmd}`, { mode: "no-cors" })
    .catch(() => alert("Ошибка соединения"));
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
